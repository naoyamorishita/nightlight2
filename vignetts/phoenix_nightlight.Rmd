# Introduction
This vignett is a part of USF project in Clark University, and we want to answer to the question "Are Neighborhoods with Public Housing Projects Brighter?" using Phoenix Arizona as a case study.

# Datasets
Here is a list of datasets that will be used

- Artificial light at night (ALAN) radiance data
- SAVI in Jun 2022
- NDBI in Jun 2022
- Population Data in 2020
- Public Housing Data updated in 2023

I came to realize that the building footprint layer did not cover the whole city area. Therefore, I used Normalized Difference Built- up Index and the number of public housing units as alternative variables.

```{r, include = F}
# Reading files----
library(geospaar)
b <- st_read("./data/boundary.geojson") %>% 
  st_as_sf() %>% 
  st_transform(26949) # NAD 83 for Arizona Central
total_avg <- raster::raster("./data/total_mean.tif")
savi <- raster::raster("./data/savi_2206.tif")
ndbi <- raster::raster("./data/ndbi_2206.tif")
population <- raster::raster("./data/pop_grid.tif")
ph_unit <- raster::raster("./data/ph_unitr.tif")
ph_count <- raster::raster("./data/ph_countr.tif")

# Changing crs & extent----
crs(total_avg) <- crs(b)
crs(savi) <- crs(b)
crs(ndbi) <- crs(b)
crs(ph_unit) <- crs(b)
crs(population) <- crs(b)
crs(ph_count) <- crs(b)

extent(population) <- extent(total_avg)

# Combning all rasters----
all <- brick(total_avg, savi, ndbi, population, ph_unit, ph_count)
```

# Plotting the Data
Let's plot them! 
```{r, fig.width=6, fig.height=6, fig.align = "left", warning = FALSE, message = FALSE}
# Defining titles----
titles <- c("Radiance", "SAVI", "NDBI", "Population", "PH Unit", "PH Count")

# Plotting without axes----
plot_noaxes(all, main = titles)
```

## Grids with Public Housings
The above images does not show the public housing well, so I will plot the grid with public housings
```{r, fig.width=4, fig.height=4, fig.align = "left", warning = FALSE, message = FALSE}
# Creating a new raster showing grids with ph----
ph_count_2 <- ph_count
ph_count_2[ph_count_2 > 1] <- 1 # assigning a dummy value # into grids with 1 or more phs

# Plotting without axes
plot_noaxes(ph_count_2, legend = F)
```

# Answering the Question
Let's answer the question of "Are Neighborhoods with Public Housing Projects Brighter?" 
Before that, let's see the relationship night light radiance and each variable. The results were overall the same what I have expected:

- Positive correlations between radiance and population, pubic housing unit and count
- Negative correlations between radiance and vegetations (i.e., SAVI)

However, what I was intrigued was there was a negative correlation between the ALAN radiance and NDBI which shows extents of urbanization. This could disagree with some previous studies.
```{r, fig.width=6, fig.height=6, fig.align = "left", warning = FALSE, message = FALSE}
# Creating a new polygon from the brick----
all_p <- rasterToPolygons(all) %>% 
  st_as_sf() %>% 
  na.omit(.) %>% # removing na values
  rename(radiance = layer.1, # making columns "meaningful" 
         savi = layer.2,
         ndbi = layer.3,
         pop = layer.4,
         ph_unit= layer.5,
         ph_count = layer.6)

# Creating 5 scatter plots----
g1 <- all_p %>% ggplot() + 
  geom_point(aes(x = pop, y = radiance)) + # putting population val on x # putting radiance on y
  geom_smooth(aes(x = pop, y = radiance), method = "lm") + # adding regression line
  xlab("Population") + ylab("Radiance") + # defining x & y labels
  ggtitle("Population & Radiance") # adding a title

g2 <- all_p %>% ggplot() + 
  geom_point(aes(x = savi, y = radiance)) +
  geom_smooth(aes(x = savi, y = radiance), method = "lm") + 
  xlab("SAVI") + ylab("Radiance") +
  ggtitle("SAVI & Radiance")

g3 <- all_p %>% ggplot() + 
  geom_point(aes(x = ndbi, y = radiance)) +
  geom_smooth(aes(x = ndbi, y = radiance), method = "lm") + 
  xlab("NDBI") + ylab("Radiance") +
  ggtitle("NDBI & Radiance")

g4 <- all_p %>% 
  filter(ph_unit > 0) %>% 
  ggplot() + 
  geom_point(aes(x = ph_unit, y = radiance)) +
  geom_smooth(aes(x = ph_unit, y = radiance), method = "lm") + 
  xlab("PH Unit") + ylab("Radiance") +
  ggtitle("Public Housing Unit & Radiance")
  
g5 <- all_p %>% 
  filter(ph_count > 0) %>% 
  ggplot() + 
  geom_point(aes(x = ph_count, y = radiance)) +
  geom_smooth(aes(x = ph_count, y = radiance), method = "lm") + 
  xlab("PH Count") + ylab("Radiance") +
  ggtitle("Public Housing Count & Radiance")

# Showing 5 plots
cowplot::plot_grid(g1, g2, g3, g4, g5, # adding 5 plots
                   nrow = 3, # with 3 rows
                   align = "vh", # vertically & horizontally alligned
                   axis = "l") # aligned to left
  
```

## Comparing Night Light Radiance of PH Grid with non- PH Grid
To do this, we will compare night light radiance of population class between grids with PH and without. (I aborted NDBI, since it showed negative correlation with the ALAN radiance). To be specific

1. Assigning quantiles
2. Assigning Ph status
3. Comparing the grids using boxplot.

There are 2 missing class with public housing grids. However, their median looks higher than those without in 6 grids out of the other 8.
```{r, fig.width=6, fig.height=6, fig.align = "left", warning = FALSE, message = FALSE}
# Assigning the quantiles----
pop_q <- all_p %>% 
  pull(pop) %>% # using pop column
  quantile(., # calculating quantile
           probs = seq(0, 1, 0.1)) # setting probabilities for making every 0.2 threshold

all_df <- st_drop_geometry(all_p) %>% as.data.frame()

all_df <- all_df %>% 
  mutate(q = ifelse(pop < pop_q[2], 1,
             ifelse(pop < pop_q[3], 2,
             ifelse(pop < pop_q[4], 3,
             ifelse(pop < pop_q[5], 4,
             ifelse(pop < pop_q[6], 5,
             ifelse(pop < pop_q[7], 6,
             ifelse(pop < pop_q[8], 7,
             ifelse(pop < pop_q[9], 8,
             ifelse(pop < pop_q[10], 9, 10))))))))) %>% 
           as.factor()
)

# Assigning ph status----
all_df <- all_df %>% 
  mutate(ph_level = ifelse(ph_count > 0, "PH", "NoPH")) # adding a columns showing ph status

# Creating box plots----
all_df %>% 
  ggplot() + geom_boxplot(aes(x = q, # putting pop level on x
                              y = radiance, # putting radiance on y
                              fill = ph_level)) + # dividing by ph_status
  xlab("Population Level") + # adding x label
  scale_fill_manual(values = c("red", "blue")) # adding colors
```

## Calculating Medians
Finally I want to show the "strict" medians of the radiance and population level between the PH grids and the non- PH grids.
NA means the 2 missing class with public housing grids.
```{r, fig.width=4.5, fig.height=4.5, fig.align = "left", warning = FALSE, message = FALSE}
all_df %>%
  st_drop_geometry() %>% # converting sf to df
  group_by(ph_level, q) %>% # grouping by ph level and population quantile
  summarize(Radiance = median(radiance)) %>% # calculating medians
  pivot_wider(names_from = ph_level, values_from = Radiance) %>% # adding columns for comparison
  mutate(Difference = PH - NoPH) %>% # adding a column
  rename(PopulationLevel = q) # renaming a column
```

# Conclusion
Basically, the ALAN radiance from grids with public housing are higher than from those without, with similar population size in Phoenix Arizona.
